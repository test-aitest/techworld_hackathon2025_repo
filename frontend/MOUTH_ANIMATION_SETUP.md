# 口ぱくぱくアニメーション機能 セットアップガイド

## 概要
このアプリは、Canvasに描かれた顔の口を自動検出し、ぱくぱく動かすアニメーション機能を実装しています。

## 主な機能

### 1. スクリーンショット取得
- 実際に画面に表示されているキャンバスの内容をキャプチャ
- Gemini APIに送信する画像の精度を向上

### 2. Gemini APIによる口の検出
- Gemini 2.0 Flash APIを使用して、画像内の口の位置を特定
- 正規化座標（0.0-1.0）で位置とサイズを取得

### 3. ぱくぱくアニメーション
- 検出された口の部分を縦方向に縮小・拡大
- 0.3秒周期で繰り返しアニメーション

## 使い方

1. **絵を描く**: Canvasに人や生き物の顔を描く
2. **検出開始**: 右上の「→」ボタンをタップ
3. **アニメーション表示**: 口が検出され、ぱくぱくアニメーションが開始
4. **停止**: 赤い「🔴停止」ボタンで停止可能
5. **再検出**: 停止後、再度「→」ボタンで検出可能

## デバッグ機能: スクリーンショット保存（オプション）

検出に使用された画像を確認したい場合、以下の設定が必要です。

### ステップ1: Info.plistに権限を追加

1. **Xcodeでプロジェクトを開く**
2. **プロジェクトナビゲーター**で`eigotchi`をクリック
3. **TARGETS**から`eigotchi`を選択
4. **Info**タブを開く
5. **Custom iOS Target Properties**セクションで**+**ボタンをクリック
6. **キー**に `Privacy - Photo Library Additions Usage Description` を入力
   - または `NSPhotoLibraryAddUsageDescription` を入力
7. **値**に説明文を入力:
   ```
   描画したイラストの検出精度を確認するため、スクリーンショットを保存します。
   ```

### ステップ2: デバッグフラグを有効化

`CanvasView.swift`の30行目を編集:

```swift
private let shouldSaveScreenshotForDebug = true  // falseをtrueに変更
```

### ステップ3: 動作確認

1. アプリを実行
2. 顔を描いて「→」ボタンをタップ
3. **初回のみ**: フォトライブラリへのアクセス許可を求められるので「許可」をタップ
4. iPadの「写真」アプリを開く
5. 保存されたスクリーンショットを確認
6. この画像がGemini APIに送信されたものです

## トラブルシューティング

### 口の検出精度が低い場合

1. **口をより明確に描く**
   - 口は顔の下部に配置
   - 横長の形状（楕円形や弧）
   - 十分な大きさで描く

2. **スクリーンショットを確認**
   - デバッグ機能を有効化して、送信された画像を確認
   - 画像が不明瞭な場合は描画を調整

3. **赤い枠で検出領域を確認**
   - アニメーション開始時、赤い枠が表示されます
   - この枠が口以外を囲んでいる場合は、再検出を試す

### クラッシュする場合

- `shouldSaveScreenshotForDebug = false` に設定されているか確認
- Info.plistに権限が追加されているか確認

## 技術詳細

### ファイル構成

- **CanvasView.swift**: メインのキャンバスビュー、口検出ロジック
- **GeminiService.swift**: Gemini API連携サービス
- **MouthAnimationView.swift**: 口のアニメーション表示ビュー

### API設定

Gemini APIキーは `CanvasView.swift` の25行目に設定:

```swift
private let geminiAPIKey = "YOUR_API_KEY_HERE"
```

**注意**: 本番環境では、APIキーを環境変数やKeychainで安全に管理してください。

## 改善案

1. **複数の口に対応**: 現在は1つの口のみ検出
2. **瞬きアニメーション**: 目も検出して瞬きを追加
3. **音声連動**: マイク入力に合わせて口を動かす
4. **キャッシュ機能**: 一度検出した口の位置を保存

---

質問や問題がある場合は、コンソールログを確認してください。
検出プロセスの各ステップで詳細なログが出力されます。
